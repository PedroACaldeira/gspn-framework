<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
  <title>GSPN Visualization</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="./static/css/gspn_visualization_template.css">
  <body>
    {% extends "gspn_visualization_template.html" %}
    {% block content %}

    <div class='button_container'>
      <a href=# id=test><button class='new-button'>Simulate 1 Step</button></a>
      <a href=# id=reset><button class='new-button new-button-red'>Reset Simulation</button></a>
      <form action="{{ url_for('background_fire_chosen_transition') }}" method="post" id="userTransitionForm" enctype="multipart/form-data">
          <input name="user_transition_text" class="input_box">
          <input id="checkUserTransition" type="submit" class='new-button' value="Fire Chosen Transition">
      </form>
    </div>

    <div id="frame_container">
        <div id="mynetwork"></div>
        <div id="dataAnalysis">

            <table style="width:100%">
                <tr>
                    <th class="analysis-title">Input</th>
                    <th class="analysis-title">Analysis Tools</th>
                    <th class="analysis-title">Output</th>
                </tr>

                <tr id="Liveness" class="data_entry">
                    <form action="{{ url_for('background_check_liveness') }}" method="post" id="livenessForm" enctype="multipart/form-data">
                        <th></th>
                        <th><input id="checkLiveness" type="submit" class='new-button-data' value="Check Liveness"></th>
                        <th><output id="liveResult" class="result_box" ></output></th>
                    </form>
                </tr>

                <tr id="ThroughputRate" class="data_entry">
                    <form action="{{ url_for('background_check_throughputrate') }}" method="post" id="throughputRateForm" enctype="multipart/form-data">
                        <th> <input name="throughput_rate_text" class="input_box"> </th>
                        <th><input id="checkThroughputRate" type="submit" class='new-button-data' value="Check Throughput Rate"></th>
                        <th><output id="throughputRateResult" class="result_box" ></output></th>
                    </form>
                </tr>

                <tr id="ProbNTokens" class="data_entry">
                    <form action="{{ url_for('background_check_probntokens') }}" method="post", target="probNTokensResult">
                        <th><input name="prob_n_tokens_text" class="input_box"></th>
                        <th><input id="checkProbNTokens" type="submit" class='new-button-data' value="Prob N Tokens"></th>
                        <th><iframe id="probNTokensResult" name="probNTokensResult" class="result_box" >-</iframe></th>
                    </form>
                </tr>

                <tr id="ExpectedNTokens" class="data_entry">
                    <form action="{{ url_for('background_check_expectedntokens') }}" method="post", target="expectedNTokensResult">
                        <th><input name="expected_n_tokens_text" class="input_box"></th>
                        <th><input id="checkExpectedNTokens" type="submit" class='new-button-data' value="Check Expected N Tokens"></th>
                        <th><iframe id="expectedNTokensResult" name="expectedNTokensResult" class="result_box" >-</iframe></th>
                    </form>
                </tr>

                <tr id="TransitionProbEvolution" class="data_entry">
                    <form action="{{ url_for('background_check_transitionprobevo') }}" method="post", target="transitionProbEvoResult">
                        <th><input name="transition_prob_evo_text" class="input_box"></th>
                        <th><input id="checkTransitionProbEvo" type="submit" class='new-button-data' value="Check Transition Probability Evolution"></th>
                        <th><iframe id="transitionProbEvoResult" name="transitionProbEvoResult" class="result_box" >-</iframe></th>
                    </form>
                </tr>

                <tr id="MeanWaitTime" class="data_entry">
                    <form action="{{ url_for('background_check_meanwaittime') }}" method="post", target="meanWaitTimeResult">
                        <th><input name="mean_wait_time_text" class="input_box"></th>
                        <th><input id="checkMeanWaitTime" type="submit" class='new-button-data' value="Check Mean Wait Time"></th>
                        <th><iframe id="meanWaitTimeResult" name="meanWaitTimeResult" class="result_box" >-</iframe></th>
                    </form>
                </tr>
            </table>
        </div>
        <div id="clear"></div>
    </div>
    <script type="text/javascript">

      var nodes = new vis.DataSet({});
      var edges = new vis.DataSet({});

      // Create nodes for the places
      var parsed_places = JSON.parse('{{data.get_places() | tojson}}');
      for(place in parsed_places) {
        var marking = parsed_places[place];
        image_link = 'https://raw.githubusercontent.com/PedroACaldeira/gspn-framework/master/images/token_' + marking + '.png';
        nodes.add({id:place, shape:'circularImage', color:'black', title:place, physics:'false', label:place, image:image_link});
      }

      // Create nodes for the transitions
      var parsed_transitions = JSON.parse('{{data.get_transitions() | tojson}}');
      console.log(parsed_transitions);
      for(transition in parsed_transitions) {
        console.log(parsed_transitions[transition][0]);
        if(parsed_transitions[transition][0] == 'exp') {
          nodes.add({id:transition, title:transition, color: {background:'white', border:'black'}, shape:'square', physics:'false', label:transition, size:10});
        }
        else {
          nodes.add({id:transition, title:transition, color:'black', shape:'square', physics:'false', label:transition, size:10});
        }
      }

      // Get edge information
      var arcs_in = {{ data.get_arcs_dict()[0] }}
      var arcs_out = {{ data.get_arcs_dict()[1] }}

      // Create edges from places to transitions
      for(place in arcs_in){
        var parsed_places_map = JSON.parse('{{data.index_to_places | tojson}}');
        var place_id = parsed_places_map[place];
        for(transition in arcs_in[place]){
          var parsed_transitions_map = JSON.parse('{{data.index_to_transitions | tojson}}');
          var transition_id = parsed_transitions_map[arcs_in[place][transition]];
          edges.add({from:place_id, to:transition_id, arrows:'to', color:'black'});
        }
      }

      // Create edges from transitions to places
      for(transition in arcs_out){
        var parsed_transitions_map = JSON.parse('{{data.index_to_transitions | tojson}}');
        var transition_id = parsed_transitions_map[transition];
        for(place in arcs_out[transition]){
          var parsed_places_map = JSON.parse('{{data.index_to_places | tojson}}');
          var place_id = parsed_places_map[arcs_out[transition][place]];
          edges.add({from:transition_id, to:place_id, arrows:'to', color:'black'});
        }
      }

      // create a network
      var container = document.getElementById('mynetwork');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {};
      var network = new vis.Network(container, data, options);
    </script>

    </body>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type=text/javascript>

            function sleep(ms) {
              return new Promise(resolve => setTimeout(resolve, ms));
            }
            async function change_color(transition, places) {
                console.log(transition);
                nodes.update({id:transition, color:{border:'yellow'}, shadow:{enabled:true, color:'yellow', x:0, y:0, size:20}});
                await sleep(1000);
                nodes.update({id:transition, color:{border:'black'}, shadow:{enabled:false}});
                for(place in places) {
                  var marking = places[place];
                  image_link = 'https://raw.githubusercontent.com/PedroACaldeira/gspn-framework/master/images/token_' + marking + '.png';
                  nodes.update({id:place, image:image_link});
                }
            }

            $(function() {
              $('a#test').bind('click', function() {
                $.getJSON('/background_process_test', function(data) {
                  change_color(data[1], data[0]);
                });
                return false;
              });

              $('a#reset').bind('click', function() {
                $.getJSON('/background_reset_simulation', function(data) {
                  console.log(data);
                  for(place in data) {
                    var marking = data[place];
                    image_link = 'https://raw.githubusercontent.com/PedroACaldeira/gspn-framework/master/images/token_' + marking + '.png';
                    nodes.update({id:place, image:image_link});
                  }
                });
                return false;
              });

              $('#livenessForm').on('submit', function (e) {
                e.preventDefault();

                var form = $(this)[0];
                var formData = new FormData(form);

                $.ajax({
                    url: '/background_check_liveness',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                        document.getElementById('liveResult').innerHTML = data;
                    }
                });
              });

              $('#throughputRateForm').on('submit', function (e) {
                e.preventDefault();

                var form = $(this)[0];
                var formData = new FormData(form);

                $.ajax({
                    url: '/background_check_throughputrate',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                        document.getElementById('throughputRateResult').innerHTML = data;
                    }
                });
              });

              $('#userTransitionForm').on('submit', function (e) {
                e.preventDefault();

                var form = $(this)[0];
                var formData = new FormData(form);

                $.ajax({
                    url: '/background_fire_chosen_transition',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                        if(data[0]=="NOT-ENABLED") {
                            window.alert("The transition is not enabled: " + data[1])
                        }
                        else {
                            change_color(data[1], data[0]);
                        }
                    }
                });
              });


            });
    </script>



    {% endblock %}

</html>