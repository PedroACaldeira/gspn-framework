<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
  <title>Network</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="./static/css/gspn_visualization_template.css">
  <body>
    {% extends "gspn_visualization_template.html" %}
    {% block content %}

    <div class='button_container'>
      <a href=# id=test><button class='new-button'>Simulate 1 Step</button></a>
      <a href=# id=reset><button class='new-button new-button-red'>Reset Simulation</button></a>
    </div>
    <div id="frame_container">
        <div id="mynetwork"></div>
        <div id="dataAnalysis">

            <div id="Liveness" class="data_entry">
                <a id="liveResult" class="result_box" >-</a>
                <a href=# id=checkLiveness><button class='new-button-data'>Check Liveness</button></a>
            </div>

            <div id="ThroughputRate" class="data_entry">
                <form action="{{ url_for('background_check_throughputrate') }}" method="post">
                    <input name="throughput_rate_text" class="input_box">
                    <input id="checkThroughputRate" type="submit" class='new-button-data' value="Check Throughput Rate">
                    <output name="throughputRateResult" class="result_box" >-</output>
                </form>
            </div>

            <div id="ProbNTokens" class="data_entry">
                <a href=# id=checkProbNTokens><button class='new-button-data'>Check Prob of N Tokens</button></a>
                <a id="checkProbNTokensResult"></a>
            </div>

            <div id="ExpectedNTokens" class="data_entry">
                <a href=# id=checkExpectedNTokens><button class='new-button-data'>Expected number of Tokens</button></a>
                <a id="checkExpectedNTokensResult"></a>
            </div>
            <div id="TransitionProbEvolution" class="data_entry">
                <a href=# id=checkTransitionProbEvolution><button class='new-button-data'>Transition prob evolution</button></a>
                <a id="checkTransitionProbEvolutionResult"></a>
            </div>
            <div id="MeanWaitTime" class="data_entry">
                <a href=# id=checkMeanWaitTime><button class='new-button-data'>Mean Wait Time</button></a>
                <a id="checkMeanWaitTimeResult"></a>
            </div>
            <div id="MaxLikelihoodTransition" class="data_entry">
                <a href=# id=checkMaxLikelihoodTransition><button class='new-button-data'>Max Likelihood Transition</button></a>
                <a id="checkMaxLikelihoodTransitionResult"></a>
            </div>
        </div>
        <div id="clear"></div>
    </div>
    <script type="text/javascript">

      var nodes = new vis.DataSet({});
      var edges = new vis.DataSet({});

      // Create nodes for the places
      var parsed_places = JSON.parse('{{data.get_places() | tojson}}');
      for(place in parsed_places) {
        var marking = parsed_places[place];
        image_link = 'https://raw.githubusercontent.com/PedroACaldeira/gspn-framework/master/images/token_' + marking + '.png';
        nodes.add({id:place, shape:'circularImage', color:'black', title:place, physics:'false', label:place, image:image_link});
      }

      // Create nodes for the transitions
      var parsed_transitions = JSON.parse('{{data.get_transitions() | tojson}}');
      console.log(parsed_transitions);
      for(transition in parsed_transitions) {
        console.log(parsed_transitions[transition][0]);
        if(parsed_transitions[transition][0] == 'exp') {
          nodes.add({id:transition, title:transition, color:'white', shape:'square', physics:'false', label:transition, size:10});
        }
        else {
          nodes.add({id:transition, title:transition, color:'black', shape:'square', physics:'false', label:transition, size:10});
        }
      }

      // Get edge information
      var arcs_in = {{ data.get_arcs_dict()[0] }}
      var arcs_out = {{ data.get_arcs_dict()[1] }}

      // Create edges from places to transitions
      for(place in arcs_in){
        var parsed_places_map = JSON.parse('{{data.index_to_places | tojson}}');
        var place_id = parsed_places_map[place];
        for(transition in arcs_in[place]){
          var parsed_transitions_map = JSON.parse('{{data.index_to_transitions | tojson}}');
          var transition_id = parsed_transitions_map[arcs_in[place][transition]];
          edges.add({from:place_id, to:transition_id, arrows:'to', color:'black'});
        }
      }

      // Create edges from transitions to places
      for(transition in arcs_out){
        var parsed_transitions_map = JSON.parse('{{data.index_to_transitions | tojson}}');
        var transition_id = parsed_transitions_map[transition];
        for(place in arcs_out[transition]){
          var parsed_places_map = JSON.parse('{{data.index_to_places | tojson}}');
          var place_id = parsed_places_map[arcs_out[transition][place]];
          edges.add({from:transition_id, to:place_id, arrows:'to', color:'black'});
        }
      }

      // create a network
      var container = document.getElementById('mynetwork');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {};
      var network = new vis.Network(container, data, options);
    </script>

    </body>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type=text/javascript>
            $(function() {
              $('a#test').bind('click', function() {
                $.getJSON('/background_process_test', function(data) {
                  console.log(data);
                  for(place in data) {
                    var marking = data[place];
                    image_link = 'https://raw.githubusercontent.com/PedroACaldeira/gspn-framework/master/images/token_' + marking + '.png';
                    nodes.update({id:place, image:image_link});
                  }
                });
                return false;
              });
              $('a#reset').bind('click', function() {
                $.getJSON('/background_reset_simulation', function(data) {
                  console.log(data);
                  for(place in data) {
                    var marking = data[place];
                    image_link = 'https://raw.githubusercontent.com/PedroACaldeira/gspn-framework/master/images/token_' + marking + '.png';
                    nodes.update({id:place, image:image_link});
                  }
                });
                return false;
              });
              $('a#checkLiveness').bind('click', function() {
                $.getJSON('/background_check_liveness', function(data) {
                  console.log(data);
                  document.getElementById('liveResult').innerHTML = data;
                });
                return false;
              });

              $('a#checkThroughputRate').bind('click', function() {
                $.getJSON('/background_check_throughputrate', function(data) {
                  console.log(data);
                  document.getElementById('throughputRateResult').innerHTML = data;
                });
                return false;
              });
            });
    </script>



    {% endblock %}

</html>